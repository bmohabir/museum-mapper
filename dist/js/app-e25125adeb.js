function isNarrow(){var e=window.innerWidth;return e<1e3}function arraysEqual(e,t){if(e.length!==t.length)return!1;for(var a=e.length;a>=0;a--)if(e[a]!==t[a])return!1;return!0}function showMenu(){$slideMenu.width(240),window.setTimeout(function(){$searchBox.focus()},500)}function hideMenu(){$slideMenu.width(0)}function initMarkers(){model.museumsData.forEach(function(e,t){var a,o,r=e.location,n=e.name,s=viewModel.getMuseum(t).fav();storageAvailable&&s?(a=markerIcons.fav.def,o=markerIcons.fav):(a=markerIcons.def.def,o=markerIcons.def);var i=new google.maps.Marker({position:r,title:n,animation:google.maps.Animation.DROP,id:t,icon:a,icons:o});i.addListener("click",function(){selectMarker(this)}),markers.push(i)}),bounds=new google.maps.LatLngBounds,markers.forEach(function(e){e.setMap(map),bounds.extend(e.position)}),map.fitBounds(bounds)}function selectMarker(e){var t=markers[e.id],a=infoWindow.marker;a!=t&&(a&&deselectMarker(a),t.setAnimation(google.maps.Animation.BOUNCE),t.setIcon(t.icons.bounce),openInfoWindow(t),isNarrow()&&hideMenu())}function deselectMarker(e){e.setAnimation(null),e.setIcon(e.icons.def),infoWindow.marker=null,infoWindow.setContent("")}function openInfoWindow(marker){var name=marker.title,id=marker.id,$name=$(eval(infoWindowTemplates.name)),$favStar=$(eval(infoWindowTemplates.star)),$head=$(infoWindowTemplates.head).append($name).append($favStar),$foursquare=$(infoWindowTemplates.foursquare),$eventful=$(infoWindowTemplates.eventful),$root=$(infoWindowTemplates.root).append($head).append($foursquare).append($("<hr>")).append($eventful),content=$root[0].outerHTML;infoWindow.setContent(content),infoWindow.marker=marker,infoWindow.open(map,marker),getFoursquareData(marker),getEventfulData(marker),infoWindow.addListener("closeclick",function(){deselectMarker(marker)});var $infoWindowHead=$(".infowindow-head")[0];ko.applyBindingsToDescendants(viewModel,$infoWindowHead)}function refreshInfoWindow(){var e=infoWindow.marker;infoWindow.open(map,e)}function foursquareRenderError(data){var $foursquare=$(".foursquare").text(""),errorSrc="Foursquare",errorMsg=data.text,errorCode="timeout"===errorMsg?"":data.error>0?data.error+" ":"Unknown ",$error=$(eval(infoWindowTemplates.errorMsg));$foursquare.append($error),refreshInfoWindow()}function foursquareRenderInfo(data){var $foursquare=$(".foursquare").text(""),name=infoWindow.marker.title,$icons=$(infoWindowTemplates.fsIcons),iconSize=img.iconSize();data.categories.forEach(function(cat){var iconURL=cat.icon.prefix+iconSize+cat.icon.suffix,iconName=cat.name,$icon=$(eval(infoWindowTemplates.icon));$icons.append($icon)});for(var photoSize=img.photoSize(),sizeString=photoSize+"x"+photoSize,photoURL=data.bestPhoto.prefix+sizeString+data.bestPhoto.suffix,$photo=$(eval(infoWindowTemplates.fsPhoto)),address=data.location.formattedAddress,lineOne=address[0],lineTwo=address[1],$address=$(eval(infoWindowTemplates.address)),phone=data.contact.formattedPhone,$phone=$(eval(infoWindowTemplates.phone)),hours="",timeframes=data.hours.timeframes,tfLength=timeframes.length,i=0;i<tfLength;i++){for(var days=timeframes[i].days,openTimes="",open=timeframes[i].open,oLength=open.length,j=0;j<oLength;j++){var times=open[j].renderedTime;openTimes+=times,oLength>j+1&&(openTimes+=", ")}hours+=days+" "+openTimes,tfLength>i+1&&(hours+="<br>")}var status,currentStatus=data.hours.status,statusType=currentStatus.split(" ")[0];switch(statusType){case"Closed":status='<span class="status-red">'+currentStatus+"</span>";break;case"Closing":case"Closes":status='<span class="status-orange">'+currentStatus+"</span>";break;case"Open":status='<span class="status-blue">'+currentStatus+"</span>";break;default:status=currentStatus}var $hours=$(eval(infoWindowTemplates.hours)),ratingColor="#"+data.ratingColor,rating=data.rating,$rating=$(eval(infoWindowTemplates.rating)),url=data.url,$website=$(eval(infoWindowTemplates.website)),$info=$(infoWindowTemplates.fsInfo).append($address).append($phone).append($hours).append($rating).append($website),$socialmedia=$(infoWindowTemplates.media),socialmedia=[];if(data.contact.facebook){var facebook="https://www.facebook.com/"+data.contact.facebook,$facebook=$(eval(infoWindowTemplates.facebook));socialmedia.push($facebook)}if(data.contact.twitter){var twitter="https://www.twitter.com/"+data.contact.twitter,$twitter=$(eval(infoWindowTemplates.twitter));socialmedia.push($twitter)}var fsURL=data.canonicalUrl,$fsLink=$(eval(infoWindowTemplates.fsLink));socialmedia.push($fsLink);for(var smLength=socialmedia.length,i=0;i<smLength;i++)$socialmedia.append(socialmedia[i]),smLength>i+1&&$socialmedia.append($("<span>&nbsp;|&nbsp;</span>"));$info.append($socialmedia);var $fsMain=$(infoWindowTemplates.fsMain).append($photo).append($info);$foursquare.removeClass("center-text").append($icons).append($fsMain),refreshInfoWindow()}function fsSuccessCallback(e){var t=e.response.venue;foursquareRenderInfo(t)}function fsErrorCallback(e){var t={error:e.status,text:e.statusText};if(e.responseJSON){var a=e.responseJSON.meta.errorType,o=e.responseJSON.meta.errorDetail;console.log("Foursquare API error "+a+": "+o)}foursquareRenderError(t)}function getFoursquareData(e){var t=viewModel.getMuseum(e.id).fsID,a="ZKNJGS3QLW32133NNDFHO0O2LLEMUPJ3IOHXDU4QA133NCKR",o="PB0I1OXTRWNMUCLE40OCD3TC1P3GFRJVI13AGBPMGZ5PZIDX",r=20160909,n="https://api.foursquare.com/v2/venues/",s=n+t+"?client_id="+a+"&client_secret="+o+"&v="+r;$.get({url:s,dataType:"json",timeout:1e4,success:fsSuccessCallback,error:fsErrorCallback})}function eventfulRenderError(data){var $eventful=$(".eventful").text(""),errorSrc="Eventful",errorCode=data.error>1?data.error+" ":"",errorMsg=data.text,$error=$(eval(infoWindowTemplates.errorMsg));$eventful.append($error),refreshInfoWindow()}function eventfulRenderInfo(data){var $infowindow=$(".infowindow"),currentWidth=$infowindow.width(),$evHead=$(infoWindowTemplates.evHead),$eventful=$(".eventful").text("").removeClass("center-text").append($evHead);data.forEach(function(eventObj){var startTime=eventObj.start_time,date=startTime.split(" ")[0],month="0"===date.charAt(5)?date.slice(6,7):date.slice(5,7),day="0"===date.charAt(8)?date.slice(9,10):date.slice(8,10),formattedDate=month+"-"+day,title=eventObj.title,eventURL=eventObj.url,$eventTime=$(eval(infoWindowTemplates.eventTime)),$eventLink=$(eval(infoWindowTemplates.eventLink)),$eventItem=$(infoWindowTemplates.eventItem).append($eventTime).append($eventLink);$eventful.append($eventItem)}),$infowindow.width(currentWidth),refreshInfoWindow()}function evSuccessCallback(e){if(e.events){var t=Array.isArray(e.events.event)?e.events.event:[e.events.event];eventfulRenderInfo(t)}else evErrorCallback(e)}function evErrorCallback(e){if(e.error){var t={error:e.error,text:e.status};console.log("Eventful API error "+e.error+": "+e.description),eventfulRenderError(t)}else if(e.statusText){var t={error:e.status,text:e.statusText};eventfulRenderError(t)}else{var t={error:0,text:"Unknown error"};eventfulRenderError(t)}}function getEventfulData(e){var t=viewModel.getMuseum(e.id).evID,a="52bmjJbHHhT48jbh",o="https://api.eventful.com/json/events/search?app_key=",r="&location="+t,n=o+a+r;$.get({url:n,dataType:"jsonp",timeout:15e3,success:evSuccessCallback,error:evErrorCallback})}function markerToggleFav(e,t){var a=markers[e.id];a.icons=t?markerIcons.fav:markerIcons.def,a.animation?a.setIcon(a.icons.bounce):a.setIcon(a.icons.def)}function filterMarkers(e){markers.forEach(function(t,a){var o=!!t.getMap(),r=e.indexOf(a)!==-1;r&&!o?t.setMap(map):!r&&o&&t.setMap(null)})}function mapReset(){infoWindow.marker?refreshInfoWindow():map.fitBounds(bounds)}var storageAvailable=function(){var e,t="test";try{return localStorage.setItem(t,t),e=localStorage.getItem(t)===t,localStorage.removeItem(t),e}catch(e){return!1}}(),$slideMenu=$("#slide-menu"),$showMenu=$("#show-menu"),$hideMenu=$("#hide-menu"),$searchBox=$("#filter-query"),$mapReset=$(".map-reset");$showMenu.click(showMenu),$hideMenu.click(hideMenu),$(function(){isNarrow()?hideMenu():showMenu()});var Museum=function(obj,id){this.name=obj.name,this.fsID=obj.fsID,this.evID=obj.evID,this.fav=storageAvailable&&eval(localStorage.getItem(""+id))?ko.observable(localStorage.getItem(""+id)):ko.observable(!1),this.id=id,this.toggleFav=function(){var e=!this.fav();this.fav(e),storageAvailable&&localStorage.setItem(""+this.id,e)}},Model=function(){var e=this;this.museumsData=[{name:"American Museum of Natural History",location:{lat:40.7813241,lng:-73.9739882},fsID:"4297b480f964a52062241fe3",evID:"V0-001-000228984-0"},{name:"Brooklyn Museum",location:{lat:40.6712062,lng:-73.9636306},fsID:"427d5680f964a520a8211fe3",evID:"V0-001-000229449-9"},{name:"Intrepid Sea, Air & Space Museum",location:{lat:40.7645266,lng:-73.9996076},fsID:"49f5135cf964a5208e6b1fe3",evID:"V0-001-001711228-7"},{name:"The Metropolitan Museum of Art",location:{lat:40.7794366,lng:-73.963244},fsID:"427c0500f964a52097211fe3",evID:"V0-001-000228997-4"},{name:"Museum of Modern Art",location:{lat:40.7614327,lng:-73.9776216},fsID:"4af5a46af964a520b5fa21e3",evID:"V0-001-000160557-3"},{name:"Museum of the Moving Image",location:{lat:40.7563454,lng:-73.9239496},fsID:"424de080f964a520aa201fe3",evID:"V0-001-000448132-7"},{name:"New York Historical Society",location:{lat:40.779306,lng:-73.97427},fsID:"4b48d37df964a520d55826e3",evID:"V0-001-001084240-4"},{name:"Solomon R. Guggenheim Museum",location:{lat:40.7829796,lng:-73.9589706},fsID:"41706480f964a520a51d1fe3",evID:"V0-001-000439048-7"}],this.museums=[],function(){e.museumsData.forEach(function(t,a){e.museums.push(new Museum(t,a))})}()},model=new Model,markers=[],markerIcons={def:{def:"img/def_marker.png",bounce:"img/def_marker_bounce.png"},fav:{def:"img/fav_marker.png",bounce:"img/fav_marker_bounce.png"}},img={photoSize:function(){return 120},iconSize:function(){return 32}},mapStyle=[{elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"landscape.natural",elementType:"geometry.fill",stylers:[{color:"#f5f5f2"},{visibility:"on"}]},{featureType:"administrative",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{visibility:"on"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]},{featureType:"poi.medical",stylers:[{visibility:"off"}]},{featureType:"poi.place_of_worship",stylers:[{visibility:"off"}]},{featureType:"poi.school",stylers:[{visibility:"off"}]},{featureType:"poi.sports_complex",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#ffffff"},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{visibility:"simplified"},{color:"#ffffff"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{color:"#ffffff"},{visibility:"off"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.arterial",stylers:[{color:"#ffffff"}]},{featureType:"road.local",stylers:[{color:"#ffffff"}]},{featureType:"poi.park",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{color:"#71c8d4"}]},{featureType:"landscape",stylers:[{color:"#e5e8e7"}]},{featureType:"poi.park",stylers:[{color:"#8ba129"}]},{featureType:"road",stylers:[{color:"#ffffff"}]},{featureType:"poi.sports_complex",elementType:"geometry",stylers:[{color:"#c7c7c7"},{visibility:"off"}]},{featureType:"water",stylers:[{color:"#a0d3d3"}]},{featureType:"poi.park",stylers:[{color:"#91b65d"}]},{featureType:"poi.park",stylers:[{gamma:1.51}]},{featureType:"road.local",stylers:[{visibility:"off"}]},{featureType:"road.local",elementType:"geometry",stylers:[{visibility:"on"}]},{featureType:"poi.government",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{visibility:"simplified"}]},{featureType:"road.local",stylers:[{visibility:"simplified"}]},{featureType:"road"},{featureType:"road"},{},{featureType:"road.highway"}];$mapReset.click(mapReset);var ViewModel=function(){var self=this;self.searchQuery=ko.observable(""),self.onlyFavs=ko.observable("false"),self.lastResults=[],self.lastFavs=[],self.lastNonFavs=[],self.visibleMuseums=ko.computed(function(){var vM=[],vIDs=[],searchQuery=this.searchQuery().toLowerCase(),onlyFavs=eval(this.onlyFavs());return model.museums.forEach(function(e,t){var a=e.name.toLowerCase();a.search(searchQuery)!==-1&&(e.fav()&&onlyFavs||!onlyFavs)&&(vIDs.push(t),vM.push(e))}),arraysEqual(vIDs,this.lastResults)?vM:(filterMarkers(vIDs),this.lastResults=vIDs,vM)},self),self.visibleFavs=ko.computed(function(){var e=[];return this.visibleMuseums().forEach(function(t){t.fav()&&e.push(t)}),e},self),self.visibleNonFavs=ko.computed(function(){var e=[];return this.visibleMuseums().forEach(function(t){t.fav()||e.push(t)}),e},self),self.clickItem=function(e){selectMarker(e)},self.toggleFav=function(e){e.toggleFav(),markerToggleFav(e,e.fav())},self.getMuseum=function(e){return model.museums[e]},self.hideListItem=function(e){1===e.nodeType&&$(e).slideUp("fast",function(){$(e).remove()})},self.showListItem=function(e){1===e.nodeType&&$(e).hide().css("opacity",0).slideDown("fast").animate({opacity:1},{queue:!1,duration:"slow"})}},viewModel=new ViewModel;$(ko.applyBindings(viewModel));
function isNarrow(){var e=window.innerWidth;return e<1e3}function arraysEqual(e,a){if(e.length!==a.length)return!1;for(var t=e.length;t>=0;t--)if(e[t]!==a[t])return!1;return!0}function showMenu(){$slideMenu.width(240),setTimeout(function(){$searchBox.focus()},500)}function hideMenu(){$slideMenu.width(0)}function initMarkers(){model.museumsData.forEach(function(e,a){var t,o,r=e.location,n=e.name,s=viewModel.getMuseum(a).fav();storageAvailable&&s?(t=markerIcons.fav.def,o=markerIcons.fav):(t=markerIcons.def.def,o=markerIcons.def);var i=new google.maps.Marker({position:r,title:n,animation:google.maps.Animation.DROP,id:a,icon:t,icons:o});i.addListener("click",function(){selectMarker(this)}),markers.push(i)}),bounds=new google.maps.LatLngBounds,markers.forEach(function(e){e.setMap(map),bounds.extend(e.position)}),map.fitBounds(bounds)}function selectMarker(e){var a=markers[e.id],t=infoWindow.marker;t!=a&&(t&&deselectMarker(t),a.setAnimation(google.maps.Animation.BOUNCE),a.setIcon(a.icons.bounce),openInfoWindow(a),isNarrow()&&hideMenu())}function deselectMarker(e){e.setAnimation(null),e.setIcon(e.icons.def),infoWindow.close()}function openInfoWindow(marker){var name=marker.title,id=marker.id,$name=$(eval(infoWindowTemplates.name)),$favStar=$(eval(infoWindowTemplates.star)),$head=$(infoWindowTemplates.head).append($name).append($favStar),$foursquare=$(infoWindowTemplates.foursquare),$eventful=$(infoWindowTemplates.eventful),$root=$(infoWindowTemplates.root).append($head).append($foursquare).append($("<hr>")).append($eventful),content=$root[0].outerHTML;infoWindow.setContent(content),infoWindow.marker=marker,infoWindow.open(map,marker),getFoursquareData(marker),getEventfulData(marker),infoWindow.addListener("closeclick",function(){deselectMarker(marker)});var $infoWindowHead=$(".infowindow-head")[0];ko.applyBindingsToDescendants(viewModel,$infoWindowHead)}function refreshInfoWindow(){var e=infoWindow.marker;infoWindow.open(map,e),map.setCenter(e.getPosition());var a=$(".infowindow").height()/2;map.panBy(0,-1*a)}function foursquareRenderError(data){var $foursquare=$(".foursquare").text(""),errorSrc="Foursquare",errorMsg=data.text,errorCode="timeout"===errorMsg?"":data.error>0?data.error+" ":"Unknown ",$error=$(eval(infoWindowTemplates.errorMsg));$foursquare.append($error),refreshInfoWindow()}function foursquareRenderInfo(data){var $foursquare=$(".foursquare").text(""),name=infoWindow.marker.title,$icons=$(infoWindowTemplates.fsIcons),iconSize=img.iconSize();data.categories.forEach(function(cat){var iconURL=cat.icon.prefix+iconSize+cat.icon.suffix,iconName=cat.name,$icon=$(eval(infoWindowTemplates.icon));$icons.append($icon)});for(var photoSize=img.photoSize(),sizeString=photoSize+"x"+photoSize,photoURL=data.bestPhoto.prefix+sizeString+data.bestPhoto.suffix,$photo=$(eval(infoWindowTemplates.fsPhoto)),address=data.location.formattedAddress,lineOne=address[0],lineTwo=address[1],$address=$(eval(infoWindowTemplates.address)),phone=data.contact.formattedPhone,$phone=$(eval(infoWindowTemplates.phone)),hours="",timeframes=data.hours.timeframes,tfLength=timeframes.length,i=0;i<tfLength;i++){for(var days=timeframes[i].days,openTimes="",open=timeframes[i].open,oLength=open.length,j=0;j<oLength;j++){var times=open[j].renderedTime;openTimes+=times,oLength>j+1&&(openTimes+=", ")}hours+=days+" "+openTimes,tfLength>i+1&&(hours+="<br>")}var status,currentStatus=data.hours.status,statusType=currentStatus.split(" ")[0];switch(statusType){case"Closed":status='<span class="status-red">'+currentStatus+"</span>";break;case"Closing":case"Closes":status='<span class="status-orange">'+currentStatus+"</span>";break;case"Open":status='<span class="status-blue">'+currentStatus+"</span>";break;default:status=currentStatus}var $hours=$(eval(infoWindowTemplates.hours)),ratingColor="#"+data.ratingColor,rating=data.rating,$rating=$(eval(infoWindowTemplates.rating)),url=data.url,$website=$(eval(infoWindowTemplates.website)),$info=$(infoWindowTemplates.fsInfo).append($address).append($phone).append($hours).append($rating).append($website),$socialmedia=$(infoWindowTemplates.media),socialmedia=[];if(data.contact.facebook){var facebook="https://www.facebook.com/"+data.contact.facebook,$facebook=$(eval(infoWindowTemplates.facebook));socialmedia.push($facebook)}if(data.contact.twitter){var twitter="https://www.twitter.com/"+data.contact.twitter,$twitter=$(eval(infoWindowTemplates.twitter));socialmedia.push($twitter)}var fsURL=data.canonicalUrl,$fsLink=$(eval(infoWindowTemplates.fsLink));socialmedia.push($fsLink);for(var smLength=socialmedia.length,i=0;i<smLength;i++)$socialmedia.append(socialmedia[i]),smLength>i+1&&$socialmedia.append($("<span>&nbsp;|&nbsp;</span>"));$info.append($socialmedia);var $fsMain=$(infoWindowTemplates.fsMain).append($photo).append($info);$foursquare.removeClass("center-text").append($icons).append($fsMain),refreshInfoWindow()}function fsSuccessCallback(e){var a=e.response.venue;foursquareRenderInfo(a)}function fsErrorCallback(e){var a={error:e.status,text:e.statusText};if(e.responseJSON){var t=e.responseJSON.meta.errorType,o=e.responseJSON.meta.errorDetail;console.log("Foursquare API error "+t+": "+o)}foursquareRenderError(a)}function getFoursquareData(e){var a=viewModel.getMuseum(e.id).fsID,t="ZKNJGS3QLW32133NNDFHO0O2LLEMUPJ3IOHXDU4QA133NCKR",o="PB0I1OXTRWNMUCLE40OCD3TC1P3GFRJVI13AGBPMGZ5PZIDX",r=20160909,n="https://api.foursquare.com/v2/venues/",s=n+a+"?client_id="+t+"&client_secret="+o+"&v="+r;$.get({url:s,dataType:"json",timeout:1e4,success:fsSuccessCallback,error:fsErrorCallback})}function eventfulRenderError(data){var $eventful=$(".eventful").text(""),errorSrc="Eventful",errorCode=data.error>1?data.error+" ":"",errorMsg=data.text,$error=$(eval(infoWindowTemplates.errorMsg));$eventful.append($error),refreshInfoWindow()}function eventfulRenderInfo(data){var fsDone=!!$(".foursquare-info")[0],fsError=!!$(".infowindow-error")[0];if(!fsDone&&!fsError)return void setTimeout(function(){eventfulRenderInfo(data)},500);var $infowindow=$(".infowindow"),currentWidth=fsError?320:$infowindow.width(),$evHead=$(infoWindowTemplates.evHead),$noEvents=$(infoWindowTemplates.noEvents),$eventful=$(".eventful").text("").removeClass("center-text").append($evHead);data.length?data.forEach(function(eventObj){var startTime=eventObj.start_time,date=startTime.split(" ")[0],month="0"===date.charAt(5)?date.slice(6,7):date.slice(5,7),day="0"===date.charAt(8)?date.slice(9,10):date.slice(8,10),formattedDate=month+"-"+day,title=eventObj.title,eventURL=eventObj.url,$eventTime=$(eval(infoWindowTemplates.eventTime)),$eventLink=$(eval(infoWindowTemplates.eventLink)),$eventItem=$(infoWindowTemplates.eventItem).append($eventTime).append($eventLink);$eventful.append($eventItem)}):$eventful.append($noEvents),$infowindow.width(currentWidth),refreshInfoWindow()}function evSuccessCallback(e){if(e.total_items){var a=e.total_items>0?Array.isArray(e.events.event)?e.events.event:[e.events.event]:[];eventfulRenderInfo(a)}else evErrorCallback(e)}function evErrorCallback(e){if(e.error){var a={error:e.error,text:e.status};console.log("Eventful API error "+e.error+": "+e.description),eventfulRenderError(a)}else if(e.statusText){var a={error:e.status,text:e.statusText};eventfulRenderError(a)}else{var a={error:0,text:"Unknown error"};eventfulRenderError(a)}}function getEventfulData(e){var a=viewModel.getMuseum(e.id).evID,t="52bmjJbHHhT48jbh",o="https://api.eventful.com/json/events/search?app_key=",r="&location="+a,n=o+t+r;$.get({url:n,dataType:"jsonp",timeout:15e3,success:evSuccessCallback,error:evErrorCallback})}function markerToggleFav(e,a){var t=markers[e.id];t.icons=a?markerIcons.fav:markerIcons.def,t.animation?t.setIcon(t.icons.bounce):t.setIcon(t.icons.def)}function filterMarkers(e){markers.forEach(function(a,t){var o=!!a.getMap(),r=e.indexOf(t)!==-1;r&&!o?a.setMap(map):!r&&o&&a.setMap(null)})}function mapReset(){infoWindow.map?refreshInfoWindow():map.fitBounds(bounds)}var storageAvailable=function(){var e,a="test";try{return localStorage.setItem(a,a),e=localStorage.getItem(a)===a,localStorage.removeItem(a),e}catch(e){return!1}}(),$slideMenu=$("#slide-menu"),$showMenu=$("#show-menu"),$hideMenu=$("#hide-menu"),$searchBox=$("#filter-query"),$mapReset=$(".map-reset");$showMenu.click(showMenu),$hideMenu.click(hideMenu),$(function(){isNarrow()?hideMenu():showMenu()});var Museum=function(obj,id){this.name=obj.name,this.fsID=obj.fsID,this.evID=obj.evID,this.fav=storageAvailable&&eval(localStorage.getItem(""+id))?ko.observable(localStorage.getItem(""+id)):ko.observable(!1),this.id=id,this.toggleFav=function(){var e=!this.fav();this.fav(e),storageAvailable&&localStorage.setItem(""+this.id,e)}},Model=function(){var e=this;this.museumsData=[{name:"American Folk Art Museum",location:{lat:40.7733377,lng:-73.9813846},fsID:"4bc8ceda0687ef3bd7a3d8cc",evID:"V0-001-002983483-2"},{name:"American Museum of Natural History",location:{lat:40.7813241,lng:-73.9739882},fsID:"4297b480f964a52062241fe3",evID:"V0-001-000228984-0"},{name:"Brooklyn Museum",location:{lat:40.6712062,lng:-73.9636306},fsID:"427d5680f964a520a8211fe3",evID:"V0-001-000229449-9"},{name:"Intrepid Sea, Air & Space Museum",location:{lat:40.7645266,lng:-73.9996076},fsID:"49f5135cf964a5208e6b1fe3",evID:"V0-001-001711228-7"},{name:"The Jewish Museum",location:{lat:40.7854597,lng:-73.9571318},fsID:"4a746fb2f964a52025de1fe3",evID:"V0-001-001084061-9"},{name:"The Metropolitan Museum of Art",location:{lat:40.7794366,lng:-73.963244},fsID:"427c0500f964a52097211fe3",evID:"V0-001-000228997-4"},{name:"Museum of Arts and Design (MAD)",location:{lat:40.7673947,lng:-73.9820338},fsID:"4a6cbb32f964a52076d11fe3",evID:"V0-001-000447865-1"},{name:"Museum of Modern Art",location:{lat:40.7614327,lng:-73.9776216},fsID:"4af5a46af964a520b5fa21e3",evID:"V0-001-000160557-3"},{name:"Museum of the Moving Image",location:{lat:40.7563454,lng:-73.9239496},fsID:"424de080f964a520aa201fe3",evID:"V0-001-000448132-7"},{name:"New York Hall of Science",location:{lat:40.7473311,lng:-73.8517438},fsID:"45545fd1f964a520043d1fe3",evID:"V0-001-007881154-7"},{name:"New York Historical Society",location:{lat:40.779306,lng:-73.97427},fsID:"4b48d37df964a520d55826e3",evID:"V0-001-001084240-4"},{name:"New York Transit Museum",location:{lat:40.6904104,lng:-73.9898535},fsID:"45727340f964a520733e1fe3",evID:"V0-001-001202380-9"},{name:"Queens Museum",location:{lat:40.74591,lng:-73.84689},fsID:"4a3d33ecf964a520f3a11fe3",evID:"V0-001-007432321-1"},{name:"Solomon R. Guggenheim Museum",location:{lat:40.7829796,lng:-73.9589706},fsID:"41706480f964a520a51d1fe3",evID:"V0-001-000439048-7"},{name:"Whitney Museum of American Art",location:{lat:40.7396091,lng:-74.0088604},fsID:"421a7600f964a5209d1f1fe3",evID:"V0-001-000965487-6"}],this.museums=[],function(){e.museumsData.forEach(function(a,t){e.museums.push(new Museum(a,t))})}()},model=new Model,markers=[],markerIcons={def:{def:"img/def_marker.png",bounce:"img/def_marker_bounce.png"},fav:{def:"img/fav_marker.png",bounce:"img/fav_marker_bounce.png"}},img={photoSize:function(){return 120},iconSize:function(){return 32}},mapStyle=[{elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"landscape.natural",elementType:"geometry.fill",stylers:[{color:"#f5f5f2"},{visibility:"on"}]},{featureType:"administrative",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{visibility:"on"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]},{featureType:"poi.medical",stylers:[{visibility:"off"}]},{featureType:"poi.place_of_worship",stylers:[{visibility:"off"}]},{featureType:"poi.school",stylers:[{visibility:"off"}]},{featureType:"poi.sports_complex",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#ffffff"},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{visibility:"simplified"},{color:"#ffffff"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{color:"#ffffff"},{visibility:"off"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.arterial",stylers:[{color:"#ffffff"}]},{featureType:"road.local",stylers:[{color:"#ffffff"}]},{featureType:"poi.park",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{color:"#71c8d4"}]},{featureType:"landscape",stylers:[{color:"#e5e8e7"}]},{featureType:"poi.park",stylers:[{color:"#8ba129"}]},{featureType:"road",stylers:[{color:"#ffffff"}]},{featureType:"poi.sports_complex",elementType:"geometry",stylers:[{color:"#c7c7c7"},{visibility:"off"}]},{featureType:"water",stylers:[{color:"#a0d3d3"}]},{featureType:"poi.park",stylers:[{color:"#91b65d"}]},{featureType:"poi.park",stylers:[{gamma:1.51}]},{featureType:"road.local",stylers:[{visibility:"off"}]},{featureType:"road.local",elementType:"geometry",stylers:[{visibility:"on"}]},{featureType:"poi.government",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{visibility:"simplified"}]},{featureType:"road.local",stylers:[{visibility:"simplified"}]},{featureType:"road"},{featureType:"road"},{},{featureType:"road.highway"}];$mapReset.click(mapReset);var ViewModel=function(){var self=this;self.searchQuery=ko.observable(""),self.onlyFavs=ko.observable("false"),self.lastResults=[],self.lastFavs=[],self.lastNonFavs=[],self.visibleMuseums=ko.computed(function(){var vM=[],vIDs=[],searchQuery=this.searchQuery().toLowerCase(),onlyFavs=eval(this.onlyFavs());return model.museums.forEach(function(e,a){var t=e.name.toLowerCase();t.search(searchQuery)!==-1&&(e.fav()&&onlyFavs||!onlyFavs)&&(vIDs.push(a),vM.push(e))}),arraysEqual(vIDs,this.lastResults)?vM:(filterMarkers(vIDs),this.lastResults=vIDs,vM)},self),self.visibleFavs=ko.computed(function(){var e=[];return this.visibleMuseums().forEach(function(a){a.fav()&&e.push(a)}),e},self),self.visibleNonFavs=ko.computed(function(){var e=[];return this.visibleMuseums().forEach(function(a){a.fav()||e.push(a)}),e},self),self.clickItem=function(e){selectMarker(e)},self.toggleFav=function(e){e.toggleFav(),markerToggleFav(e,e.fav())},self.getMuseum=function(e){return model.museums[e]},self.hideListItem=function(e){1===e.nodeType&&$(e).slideUp("fast",function(){$(e).remove()})},self.showListItem=function(e){1===e.nodeType&&$(e).hide().css("opacity",0).slideDown("fast").animate({opacity:1},{queue:!1,duration:"slow"})}},viewModel=new ViewModel;$(ko.applyBindings(viewModel));